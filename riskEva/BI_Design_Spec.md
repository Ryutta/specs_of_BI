# BI設計仕様書 - riskEva

## 1. 概要
本レポートは、リスク評価と予算申請の管理を行うためのPower BIプロジェクトです。
2026年度のリスク評価データ (`riskEva2026`) を中心に、過去の申請状況 (`Query_2024`, `Query_2025`) と比較しながら分析を行います。

## 2. データソース
- **SharePoint**: 2026年度のリスク評価データ (`riskEva2026`) は SharePoint サイト上の Excel ファイルから取得しています。
    - パス: `101P180 設備技術部 社員/N.予算管理/...`
- **PowerPlatform Dataflows**: 過去年度の申請データ (`Query_2024`, `Query_2025`) などは Dataflow から取得しています。

## 3. データモデル

### 3.1. テーブル一覧
主要なテーブルは以下の通りです。

| テーブル名 | 種類 | 説明 |
| --- | --- | --- |
| **riskEva2026** | ファクト | 2026年度のリスク評価データ |
| **Query_2024** | ファクト | 2024年度の予算申請データ |
| **Query_2025** | ファクト | 2025年度の予算申請データ |
| **プラント略号辞書** | ディメンション | 原価センタとプラントの対応 |
| **Dim_専門区分** | ディメンション | 専門区分の定義 |
| **修繕費対応分類表** | ディメンション | 修繕費分類マスタ |
| **Order_SE/QCD/法/枠/他** | ディメンション | 予算区分や判定の分類 |
| **推移** | メジャー | トレンド分析用の計算メジャーを格納 |

### 3.2. リレーションシップ図
主要なファクトテーブルとディメンションテーブルの関係を以下に示します。

```mermaid
erDiagram
    "riskEva2026" }|..|| "順序_管理区分_Table" : "管理区分"
    "riskEva2026" }|..|| "横軸_年度" : "年度"
    "riskEva2026" }|..|| "修繕費対応分類表" : "13分類rev"
    "riskEva2026" }|..|| "Order_SE/QCD/法/枠/他" : "SE/QCD/法定/枠/その他"
    "riskEva2026" }|..|| "Dim_専門区分" : "専門区分"
    "riskEva2026" }|..|| "評価ランク_Table" : "評価ランク"
    "riskEva2026" }|..|| "プラント略号辞書" : "原価センタ"

    "Query_2025" }|..|| "横軸_年度" : "年度"
    "Query_2025" }|..|| "Order_SE/QCD/法/枠/他" : "SE/QCD/法定/枠/その他"
    "Query_2025" }|..|| "プラント略号辞書" : "原価センタ"
    "Query_2025" }|..|| "Dim_専門区分" : "専門区分"
    "Query_2025" }|..|| "修繕費対応分類表" : "13分類rev"

    "Query_2024" }|..|| "順序_管理区分_Table" : "管理区分"
    "Query_2024" }|..|| "Order_SE/QCD/法/枠/他" : "SE/QCD/法定/枠/その他"
    "Query_2024" }|..|| "横軸_年度" : "年度"
    "Query_2024" }|..|| "プラント略号辞書" : "原価センタ"
    "Query_2024" }|..|| "Dim_専門区分" : "専門区分"
```

## 4. 主要テーブル詳細

### 4.1. riskEva2026
2026年度のリスク評価データです。SharePoint上のExcelファイルからデータを取り込んでいます。
- **主要カラム**:
    - `管理区分`: 管理区分コード (E, C, I など)
    - `申請予算`: 申請額
    - `積上予算`: 積み上げ予算額
    - `判定ＳＥＱＣＤ`: SE/QCD判定 (SE: 安全・環境, QCD: 品質・コスト・納期)
    - `発生確率`: リスク発生確率
    - `_影響度`: 評価スコアに基づいた影響度（保安、環境、生産、品質評価から算出）
    - `優先度`: リスクの優先度
    - `年度`: データの対象年度 ("2026" 固定)

### 4.2. Query_2024 / Query_2025
過去年度の予算申請データです。PowerPlatform Dataflows から取得しています。
- **主要カラム**:
    - `申請予算`: 申請額
    - `積上予算`: 積み上げ予算額
    - `年度`: データの対象年度
    - `原価センタ`: 所属部署
    - `予算管理No`: 予算管理のための番号

## 5. 主要メジャー (DAX)
`推移` テーブルに定義されている主要な計算式です。

- **trend_all**
    - 過去の実績と将来の予算を統合したトレンド計算です。
    - 2024年以前は実績値を使用し、2025年以降は予算値を使用します。

- **申請額_fr24to26**
    - 2024年から2026年までの申請額の合計を計算します。
    - `Query_2024`, `Query_2025`, `riskEva2026` の各テーブルのデータを合算しています。

- **件数_リスク評価**
    - リスク評価データの件数をカウントします。
    - `COUNTROWS('riskEva2026')`
